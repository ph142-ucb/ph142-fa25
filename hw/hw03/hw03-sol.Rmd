---
title: "Assignment 3: Predicting insurance charges by age and BMI"
author: "Your name and student ID"
date: "Today's date"
output: pdf_document
---

### Instructions 
* This semester, homework assignments are for practice only and will not be turned in for marks.

```{r setup, include = FALSE}
# Don't change these lines, just run them!
source("setup/hw03.RAGS.R")

```

Helpful hints:

- Every function you need to use was taught during lecture! So you may need to 
revisit the lecture code to help you along by opening the relevant files on Datahub. 
Alternatively, you may wish to view the code in the condensed PDFs posted 
on the course website. Good luck!

- Knit your file early and often to minimize knitting errors! If you copy and 
paste code for the slides, you are bound to get an error that is hard to 
diagnose. Typing out the code is the way to smooth knitting! We recommend 
knitting your file each time after you write a few sentences/add a new code 
chunk, so you can detect the source of knitting errors more easily. This will 
save you and the GSIs from frustration! **You must knit correctly before submitting.**

- It is good practice to not allow your code to run off the page. To
avoid this, have a look at your knitted PDF and ensure all the code fits in the 
file. 
If it doesn't look right, go back to your .Rmd file and add spaces (new lines) using 
the return or enter key so that the code runs onto the next line.

\newpage

--------------------------------------------------------------------------------

```{r load-libraries, message=F}
library(readr)
library(dplyr)
library(ggplot2)
library(broom)
library(forcats)
```

### Predicting insurance charges by age and BMI 

**Problem**: Medical insurance charges can vary according to the complexity of a 
procedure or condition that requires medical treatment. You are tasked with 
determining how these charges are associated with age, for patients who have a 
body mass index (bmi) in the "normal" range (bmi between 16 and 25) who are 
smokers.

**Plan**: You have chosen to use tools to examine relationships between two 
variables to address the problem. In particular, scatter plots and simple linear
regression.

**Data**: You have access to the dataset `insurance.csv`, a claims dataset from
an insurance provider.

**Analysis and Conclusion**: In this assignment you will perform the analysis 
and make a conclusion to help answer the problem statement.

\newpage

**1. [1 point] Please type one line of code below to import these data into R. Assign the data to `insure_data`. Execute the code by hitting the green arrow and ensure the data set has been saved by looking at the environment tab and viewing the data set by clicking the table icon to the right of its name.**

```{r load-insure-data}
insure_data <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
insure_data <- read_csv("insurance.csv")

# END SOLUTION
# ------- REMINDER -------
# The checks on this homework are only provided as sanity checks.
# They do not guarantee correctness.
# ------------------------

check_problem1()
```

\newpage

**Use the space below to use the functions from lecture to get to know your dataset. Execute these functions line by line so you can look at their output, and examine these data.**

```{r initial-looks}
dim(insure_data)
names(insure_data)
str(insure_data)
head(insure_data)
```

\newpage

**2. [1 point] How many individuals are in the dataset? Assign this number to p2.**
```{r p2}
p2 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p2 <- nrow(insure_data)

# END SOLUTION

check_problem2()
```

**3. [1 point] What are the nominal variables in the dataset? Assign the names of these variables to a vector of strings, p3.**
```{r p3}
p3 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p3 <- c("sex", "smoker", "region")
# END SOLUTION

check_problem3()
```

**4. [1 point] How many ordinal variables are in the dataset? Assign the number of ordinal variables to p4.**
```{r p4}
p4 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p4 <- 0
# END SOLUTION

check_problem4()
```

**5. [1 point] Are there continuous variables in the dataset? Assign the names of these variables to a vector of strings, p5.**
```{r p5}
p5 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p5 <- c("bmi", "charges", "age")
p5 <- c("bmi", "charges") # also accepted
# END SOLUTION

check_problem5()
```

**6. [1 point] What are the discrete variables in the dataset? Assign the names of these variables to a vector of strings, p6.**
```{r p6}
p6 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p6 <- c("children")
p6 <- c("children", "age") # also accepted
# END SOLUTION

check_problem6()
```

\newpage

**Run the following code by removing the "#" symbol in front of each of the six lines and executing the code chunk. Remind yourself what the `mutate()` function does in general, and notice that a new function `case_when()` is also being used.**

```{r mutate-case-when}
insure_data <- insure_data %>%
  mutate(bmi_cat = case_when(bmi < 16 ~ "Underweight",
                             bmi >= 16 & bmi < 25 ~ "Normal",
                             bmi >= 25 & bmi < 30 ~ "Overweight",
                             bmi >= 30 ~ "Obese")
                  )
```

**7. [1 point] What did the above code achieve?:**

[TODO: YOUR ANSWER HERE]

# BEGIN SOLUTION

The above code created a new variable called `bmi_cat` that created four categories
of BMI: underweight, normal, overweight, and obese, based on the continuous variable
BMI.

# END SOLUTION

\newpage

**8. [1 point] What type of variable is `bmi_cat`? Uncomment one of the choices below.**
```{r p8}
# p8 <- "ordinal"
# p8 <- "nominal"
# p8 <- "continuous"
# p8 <- "discrete"

# BEGIN SOLUTION
p8 <- "ordinal"

# END SOLUTION
# This only checks that you've selected an answer, not its correctness.
check_problem8()
```

\newpage

**9. [1 point] Read the problem statement proposed at the beginning of this exercise. Who belongs to the population of interest? Uncomment one of the choices below.** 
```{r p9}
# p9 <- "Smokers of normal BMI"
# p9 <- "Smokers of overweight BMI"
# p9 <- "Smokers who have abnormal BMI"
# p9 <- "All people at risk of high medical charges"

# BEGIN SOLUTION
p9 <- "Smokers of normal BMI"

# END SOLUTION
# This only checks that you've selected an answer, not its correctness.
check_problem9()
```


**10. [1 point] Using a dplyr function, make a new dataset called `insure_subset` containing the population of interest.**

```{r dplyr-the-data}
insure_subset <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
insure_subset <- insure_data %>% filter(smoker == "yes" & bmi_cat == "Normal")

# END SOLUTION

check_problem10()
```

\newpage

**11. [3 points] Make a scatter plot of the relationship between `age` and insurance `charges` for the population of interest. Give your plot an informative title.**

```{r scatter-plot}
p11 <- "<<<<YOUR CODE HERE>>>>"
p11

# BEGIN SOLUTION
p11 <- ggplot(insure_subset, aes(x = age, y = charges)) + 
  geom_point() +
  labs(title = "The relationship between age and insurance charges among smokers of normal BMI")
p11

# END SOLUTION

check_problem11()
```

\newpage

**12. [2 points] Run a linear regression model on the relationship between `age` and `charges`. Think about which variable is explanatory (X) and which is response (Y). Assign the regression model to the name `insure_mod`. Then type `tidy(insure_mod)` below the model's code and execute both lines.**

```{r regression-mod}
insure_model <- "<<<<YOUR CODE HERE>>>>"
# <<<<YOUR CODE HERE>>>>

# BEGIN SOLUTION
insure_model <- lm(formula = charges ~ age, data = insure_subset)
tidy(insure_model)

# END SOLUTION

check_problem12()

```

**13a. [1 point] Interpret the slope parameter:**

[TODO: YOUR ANSWER HERE]

# BEGIN SOLUTION

For every year increase in age, medical charges go up by $246.14.

# END SOLUTION

**13b. [1 point] Interpret the intercept parameter:**

[TODO: YOUR ANSWER HERE]

# BEGIN SOLUTION

The model predicts that the insurance charged would be $10,656.14 for a person of aged 0.

# END SOLUTION

**13c. [1 point] Does the intercept make sense in this context?:**

[TODO: YOUR ANSWER HERE]

# BEGIN SOLUTION

No because being 0 years old is non sensical. Further, the minimum age in the dataset is 18, so extrapolation to 0 is not supported by the data. (student can say either of these items or both.)

# END SOLUTION

\newpage

**14. [1 point] Add the line of best fit to your scatterplot by copying and pasting the plot's code from Problem 11 into the chunk below and adding a `geom` that can be used to add a regression line:**

```{r scatter-plot-with-line}
p14 <- "<<<<YOUR CODE HERE>>>>"
p14

# BEGIN SOLUTION
p14 <- ggplot(insure_subset, aes(x = age, y = charges)) + 
  geom_point() +
  labs(title = "The relationship between age and insurance charges among smokers of normal BMI") +
  geom_abline(intercept = 10656.1, slope = 246.1)
p14

# END SOLUTION

check_problem14()
```

\newpage

**15. [2 points] What do you notice about the fit of the line in terms of the proportion of points above vs. below the line. Why do you think that is?:**

[TODO: YOUR ANSWER HERE]

# BEGIN SOLUTION

The line seems high. There is a large proportion of points below the line. That's because there exists some notable outliers above the line which don't follow the linear trend of the data points.

# END SOLUTION

\newpage

**Run the following `filter()` function by removing the "#" symbol in front of the two lines of code and executing the code chunk.**

```{r filter-smalller}
insure_smaller_subset <- insure_subset %>% 
  filter(charges < 30000 & ! (charges > 25000 & age == 20))
```

**16. [2 points] How many individuals were removed? Who were they?:**

[TODO: YOUR ANSWER HERE]

# BEGIN SOLUTION

Three individuals were removed. They were the "y outliers", the two people with the highest charges in the dataset and a third person who was 20 years old with a charge > $25,000.

# END SOLUTION

\newpage

**17. [2 points] Run a regression model on `insure_smaller_subset` between `charges` and `age`. Assign it to insure_better_model and look at the output using the `tidy()` function, as was done with the previous linear model.**

```{r second-regression-mod}
insure_better_model <- "<<<<YOUR CODE HERE>>>>"
# "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
insure_better_model <- lm(formula = charges ~ age, data = insure_smaller_subset)
tidy(insure_better_model)

# END SOLUTION

check_problem17()

```

\newpage

**18. [2 points] Add the new regression line to your ggplot from Problem 14. Keep the older regression line on the plot for comparison. To distinguish them, change the color, line type, or line width of the newly-added line.**

```{r scatter-two-lines}
p18 <- "<<<<YOUR CODE HERE>>>>"
p18

# BEGIN SOLUTION
p18 <- ggplot(insure_subset, aes(x = age, y = charges)) + 
  geom_point() +
  labs(title = "The relationship between age and insurance charges among smokers of normal BMI") +
  geom_abline(intercept = 10656.1, slope = 246.1, lty = 2) + 
  geom_abline(intercept = 9144.1, slope = 266.9)
p18

# END SOLUTION

check_problem18()
```

\newpage

**19. [1 point] Calculate the r-squared value for `insure_model` using a function learned in class. Assign this value to insure_model_r2.**

```{r rsquared}
insure_model_r2 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
insure_model_r2 <- glance(insure_model) %>% pull(r.squared)

# END SOLUTION

check_problem19()
```

**20. [1 point] Calculate the r-squared value for `insure_better_model` using a function learned in class. Assign this value to insure_better_model_r2.**

```{r rsquared2}
insure_better_model_r2 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
insure_better_model_r2 <- glance(insure_better_model) %>% pull(r.squared)

# END SOLUTION

check_problem20()
```

\newpage

**21. [2 points] Calculate the correlation between `age` and `charges` using the subset `insure_subset`. Also calculate correlation squared. You should use `summarize()` and name the two new columns `corr` and `corr_sq`. What do you notice about the relationship between the correlation and r-squared values that you calculated earlier?**

```{r correlations}
p21 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p21 <- insure_subset %>% summarize(corr = cor(age, charges), corr_sq = corr^2)

# END SOLUTION

check_problem21()
```

**22. [2 points] Calculate the correlation between `age` and `charges` using the smaller dataset `insure_smaller_subset`. Also calculate correlation squared. You should use `summarize()` and name the two new columns `corr` and `corr_sq`. What do you notice about the relationship between the correlation and r-squared values that you calculated earlier?**

```{r correlations2}
p22 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p22 <- insure_smaller_subset %>% summarize(corr = cor(age, charges), corr_sq = corr^2)

# END SOLUTION

check_problem22()
```

\newpage

### PART B

**Your supervisor asks you to extend your analysis to consider other smokers with BMIs classified as overweight or obese. In particular, she wanted to know if the relationship between age and medical charges is different for different BMI groups. You can use data visualization coupled with your skills in linear regression to help answer this question.**

**23. [1 point] Make a new dataset called `insure_smokers` that includes smokers of any BMI.**

```{r dplyr-the-data-smokers}
insure_smokers <- "<<<<YOUR CODE HERE>>>>"
  
# BEGIN SOLUTION
insure_smokers <- insure_data %>% filter(smoker == "yes") 

# END SOLUTION

check_problem23()
```

\newpage

**24. [1 point] Make a scatter plot that examines the relationship between `age` and `charges` separately for normal, overweight, and obese individuals. A `facet_` command may help you.**

```{r ggplot-by-bmi}
p24 <- "<<<<YOUR CODE HERE>>>>"
p24

# BEGIN SOLUTION
p24 <- ggplot(insure_smokers, aes(x = age, y = charges)) + 
  geom_point() + 
  facet_wrap(~ bmi_cat)
p24

# END SOLUTION

check_problem24()
```

**Is there something out of order with your plot you just made? The issue is that the plot is automatically displayed by listing the BMI categories alphabetically. Uncomment and run the following code chunk to assign an ordering to the values of `bmi_cat`.**: 

```{r fct-relevel}
insure_smokers <- insure_smokers %>%
  mutate(bmi_cat_ordered = forcats::fct_relevel(bmi_cat, "Normal", "Overweight", "Obese"))
```

\newpage

**25. [1 point] Re-run your plot code, but this time, facet using `bmi_cat_ordered`.**

```{r ggplot-by-bmi-2}
p25 <- "<<<<YOUR CODE HERE>>>>"
p25

# BEGIN SOLUTION
p25 <- ggplot(insure_smokers, aes(x = age, y = charges)) + 
  geom_point() + 
  facet_wrap(~ bmi_cat_ordered)
p25

# END SOLUTION

check_problem25()
```

\newpage

**26. [3 points] Run a separate linear model for each BMI group. To do this, you will need to subset your data into the three groups of interest first. Call your models `normal_mod`, `overweight_mod`, `obese_mod`. Use the `tidy()` function to display the output from each model.**

```{r more-models-more-outputs}
# "<<<<YOUR CODE HERE>>>>"
# "<<<<YOUR CODE HERE>>>>"
# "<<<<YOUR CODE HERE>>>>"

normal_mod <- "<<<<YOUR CODE HERE>>>>"
overweight_mod <- "<<<<YOUR CODE HERE>>>>"
obese_mod <- "<<<<YOUR CODE HERE>>>>"

# "<<<<YOUR CODE HERE>>>>"
# "<<<<YOUR CODE HERE>>>>"
# "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
insure_smokers_normal <- insure_smokers %>% filter(bmi_cat == "Normal")
insure_smokers_overweight <- insure_smokers %>% filter(bmi_cat == "Overweight")
insure_smokers_obese <- insure_smokers %>% filter(bmi_cat == "Obese")

normal_mod <- lm(charges ~ age, data = insure_smokers_normal)
overweight_mod <- lm(charges ~ age, data = insure_smokers_overweight)
obese_mod <- lm(charges ~ age, data = insure_smokers_obese)

tidy(normal_mod)
tidy(overweight_mod)
tidy(obese_mod)

# END SOLUTION

check_problem26()
```

\newpage

**For the next three problems, use the models to predict medical charges for a 20-year old by weight category. You don't need an R function to make these predictions, just the output from the model. Show your work for each calculation by writing the mathematical expression in and round to the nearest dollar.**

**27. [1 point] ...among normal BMI group:**
```{r predict-1}
p27 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p27 <- 10656.1 + 246.1 * 20 # = $15578.1

# END SOLUTION

check_problem27()
```

**28. [1 point] ...among overweight BMI group:**
```{r predict-2}
p28 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p28 <- 12399.7 + 264.2 * 20 # = $17683.7

# END SOLUTION

check_problem28()
```

**29. [1 point] ...among obese BMI group:**
```{r predict-3}
p29 <- "<<<<YOUR CODE HERE>>>>"

# BEGIN SOLUTION
p29 <- 30558.1 + 281.2 * 20 # = $36182.1

# END SOLUTION

check_problem29()
```

\newpage

**30. [3 points] In three sentences maximum, (1) comment on the direction of the association, (2) comment on how much the slopes vary across the BMI groups, and (3) how much the prediction for a 20-year old varies.**

[TODO: YOUR ANSWER HERE]

# BEGIN SOLUTION

There was a positive association between age and medical charges for normal, overweight, and obese individuals. The relationship was of similar magnitude for each BMI group, though the slope increased in magnitude for overweight and obese individuals, implying that a steeper relationship for overweight individuals, and even steeper for obese individuals vs. normal BMI individuals. For a given age, obese individuals had much higher charges than overweight and normal weight individuals.

# END SOLUTION


\newpage

### Check your score

Click on the middle icon on the top right of this code chunk (with the downwards gray arrow and green bar) to run all your code in order. Then, run this chunk to check your score.
```{r check-total-score}
# Just run this chunk.
total_score()
```

